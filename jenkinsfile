pipeline {
    agent {
        node {
            label 'terraform-node'
        }
    }

    environment {
        // Jenkins credential IDs for AWS
        AWS_ACCESS_KEY_ID     = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
        AWS_DEFAULT_REGION    = 'ap-south-1'
    }

    parameters {
        choice(
            name: 'action',
            choices: ['apply', 'destroy'],
            description: 'Select Terraform action'
        )
    }

    options {
        timestamps()
        disableConcurrentBuilds()
        timeout(time: 45, unit: 'MINUTES')
    }

    stages {

        stage('Pipeline Info') {
            steps {
                echo "=========================================="
                echo "Project      : Terraform EC2 Automation"
                echo "Owner        : shubhangivspatil"
                echo "AWS Region   : ${AWS_DEFAULT_REGION}"
                echo "Action       : ${params.action}"
                echo "=========================================="
            }
        }

        stage('Checkout Code') {
            steps {
                // Checkout main branch
                git branch: 'main', url: 'https://github.com/shubhangivspatil/terraproject.git'
            }
        }
          stage('Credentials'){
            steps{
                sh '''
                mkdir -p ~/.aws
                echo "[default]" > ~/.aws/credentials 
                echo "AWS_ACCESS_KEY_ID = ${AWS_ACCESS_KEY_ID}" >> ~/.aws/credentials 
                echo "AWS_SECRET_ACCESS_KEY = ${AWS_SECRET_ACCESS_KEY}" >> ~/.aws/credentials 
                '''
            }
        }        

        stage('Terraform Format Check') {
            steps {
                sh 'terraform fmt'
            }
        }

        stage('Terraform Init') {
            steps {
                sh 'terraform init'
            }
        }

        stage('Terraform action') {

            steps {
                sh '''
                        terraform ${action} --auto-approve
                '''
            }
        }

       

    post {
        success {
            echo "âœ… Terraform ${params.action} completed successfully"
        }
        failure {
            echo "âŒ Terraform ${params.action} failed"
        }
        always {
            cleanWs() // clean workspace safely
            echo "ğŸ“Œ Pipeline finished"
        }
    }
}
