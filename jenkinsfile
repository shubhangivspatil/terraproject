pipeline{
    agent {label 'terraform-node'}
    parameters{
        choice(name:'action', choices:['apply','destroy'],description:'Select Terraform action')
    }
    stages{
        stage('Checkout Code'){
            steps{
                checkout scm
            }
        }     
        stage('Terraform Format Check'){
            steps{
                sh 'terraform fmt'
            }
        }
        stage('Terraform Init'){
            steps{                
                sh 'terraform init'
            }
        }
        stage('Terraform action'){
            steps{
                withCredentials([[$class:'AmazonWebServicesCredentialsBinding', credentialsId: 'aws_credentials']]){
                    sh '''
                    echo "Terraform action is ---> ${action}"
                    terraform ${action} --auto-approve
                    '''                    
                }
            }
        }

    }

post{
        success{
            emailext (
                subject: "SUCCESSFUL: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
                body: """
                SUCCESSFUL: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]': 
                Check console output at "${env.JOB_NAME} [${env.BUILD_NUMBER}]"
                """,
                to: 'sallyvp28@gmail.com',
                from: 'shubhangivspatil@gmail.com',
            )
        }
        failure{
            emailext (
                subject: "FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
                body: """
                FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]': 
                Check console output at "${env.JOB_NAME} [${env.BUILD_NUMBER}]"
                """,
                to: 'sallyvp28@gmail.com',
                from: 'shubhangivspatil@gmail.com',
            )
        }
    }
}

  
    
