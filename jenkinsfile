pipeline{
    agent {label 'terraform-node'}
    parameters{
        choice(name:'action', choices:['apply','destroy'],description:'Select Terraform action')
    }
    stages{
        stage('Checkout Code'){
            steps{
                checkout scm
            }
        }     
        stage('Terraform Format Check'){
            steps{
                sh 'terraform fmt'
            }
        }
        stage('Terraform Init'){
            steps{                
                sh 'terraform init'
            }
        }
        stage('Terraform action'){
            steps{
                withCredentials([[$class:'AmazonWebServicesCredentialsBinding', credentialsId: 'aws_credentials']]){
                    sh '''
                    echo "Terraform action is ---> ${action}"
                    terraform ${action} --auto-approve
                    '''                    
                }
            }
        }

    }

 post {
        success {
            emailext(
                subject: "SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
Hello Team,

The Jenkins job completed SUCCESSFULLY.

Job Name   : ${env.JOB_NAME}
Build No   : ${env.BUILD_NUMBER}
Status     : SUCCESS

Check console output:
${env.BUILD_URL}

Regards,
Jenkins
""",
                to: 'sallyvp28@gmail.com',
                replyTo: 'shubhangivspatil@gmail.com',
                mimeType: 'text/plain',
                recipientProviders: [[$class: 'DevelopersRecipientProvider']]
            )
        }

        failure {
            emailext(
                subject: "FAILED: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
Hello Team,

The Jenkins job has FAILED.

Job Name   : ${env.JOB_NAME}
Build No   : ${env.BUILD_NUMBER}
Status     : FAILURE

Please check console output:
${env.BUILD_URL}

Regards,
Jenkins
""",
                to: 'sallyvp28@gmail.com',
                replyTo: 'shubhangivspatil@gmail.com',
                mimeType: 'text/plain',
                recipientProviders: [[$class: 'DevelopersRecipientProvider']]
            )
        }
    }
}   //
